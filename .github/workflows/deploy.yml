name: OSTAD-Assignment-Module-5 CI/CD Pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:
env:
  DEPLOY_PATH: /home/ubuntu/OSTAD-Assignment-Module-5-Github-Actions
  NODE_VERSION: "20" # Node.js major version for system-wide install

jobs:
  # (Test Job)
  test:
    runs-on: self-hosted # run on ubuntu server
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # System-wide Node.js - EC2 এ node/npm সবসময় available থাকবে
      - name: Install Node.js (System-wide via NodeSource)
        run: |
          echo "=========================================="
          echo "Installing/Verifying Node.js (System-wide)"
          echo "=========================================="
          if ! command -v node &> /dev/null; then
            echo "Installing Node.js ${{ env.NODE_VERSION }} via NodeSource..."
            curl -fsSL https://deb.nodesource.com/setup_${{ env.NODE_VERSION }}.x | sudo -E bash -
            sudo apt-get install -y nodejs
            echo "Node.js $(node --version) installed system-wide"
          else
            echo "Node.js $(node --version) already installed"
          fi
          echo "npm: $(npm --version)"

      - name: Run Tests and Capture Results
        run: |
          # Dependency install & test
          npm install
          npm run check > test-results.txt || echo "Tests failed" > test-results.txt

      # Artifact Upload
      - name: Upload Test Results Artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-results-artifact
          path: test-results.txt

  # (Deploy Job)
  deploy:
    runs-on: self-hosted # run on ubuntu server
    needs: test # test job run after deploy job
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Artifact Download
      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: test-results-artifact

      - name: Display Artifact Content
        run: |
          echo "--- Test Results Start ---"
          cat test-results.txt
          echo "--- Test Results End ---"

      # Deploy job এও Node.js ensure করা (যদি test skip হয়)
      - name: Ensure Node.js is installed
        run: |
          if ! command -v node &> /dev/null; then
            echo "Node.js not found - installing via NodeSource..."
            curl -fsSL https://deb.nodesource.com/setup_${{ env.NODE_VERSION }}.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          echo "Node: $(node --version), npm: $(npm --version)"

      - name: Deployment Mechanism
        run: |
          echo "=========================================="
          echo "Deploying Application"
          echo "=========================================="
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"
          echo ""

          # Clone or pull repository
          if [ ! -d "${{ env.DEPLOY_PATH }}" ]; then
            echo "Fresh deployment - cloning repository..."
            git clone https://github.com/${{ github.repository }}.git ${{ env.DEPLOY_PATH }}
          else
            echo "Updating existing deployment..."
            cd ${{ env.DEPLOY_PATH }}
            git fetch origin
            git reset --hard origin/main
          fi

          cd ${{ env.DEPLOY_PATH }}

          # Deploy assignment-backend
          echo ""
          echo "=========================================="
          echo "Deploying assignment-backend"
          echo "=========================================="

          # Install dependencies
          echo "Installing assignment-backend dependencies..."
          npm install --production

          # Install PM2 globally (system-wide, PATH এ থাকবে)
          if ! command -v pm2 &> /dev/null; then
            echo "Installing PM2 globally..."
            sudo npm install -g pm2
            echo "PM2 installed"
            # PM2 startup - server reboot এ application auto start হবে
            sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu
          else
            echo "PM2 $(pm2 --version) already installed"
          fi

          # Check if server.js exists in src/ directory
          if [ -f "src/server.js" ]; then
            SERVER_FILE="src/server.js"
          elif [ -f "server.js" ]; then
            SERVER_FILE="server.js"
          else
            echo "Error: server.js not found in src/ or root directory"
            exit 1
          fi

          # PM2 দিয়ে application চালু/restart
          if pm2 describe assignment-backend > /dev/null 2>&1; then
            echo "Restarting application..."
            pm2 restart assignment-backend --update-env
          else
            echo "Starting application for the first time..."
            pm2 start $SERVER_FILE --name assignment-backend
          fi
          pm2 save
